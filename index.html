<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Title Sniffer (One-File Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 1rem 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,.04); max-width: 860px; }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; }
    input[type="url"], textarea { width: 100%; padding: .75rem 1rem; border-radius: 12px; border: 1px solid #d1d5db; }
    button { padding: .6rem 1rem; border-radius: 12px; border: 0; cursor: pointer; }
    .muted { color: #6b7280; font-size: .9rem; }
    .result { margin-top: 1rem; }
    .err { color: #b91c1c; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 820px) { .grid { grid-template-columns: 1fr 1fr; } }
    .label { font-weight: 600; margin-top: .25rem; }
    .kv { margin-top: .5rem; }
    .kv div { margin-bottom: .25rem; }
    .small { font-size: .85rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Title Sniffer (One-File Edition)</h1>
    <p class="muted">No backend? No problem(ish). We’ll do same-origin fetches, accept pasted HTML, or hit a metadata API you trust.</p>

    <div class="grid">
      <!-- Lane A: Same-origin fetch -->
      <section>
        <div class="label">A) Same-origin URL</div>
        <input id="sameUrl" type="url" placeholder="https://your-domain.com/some-page" />
        <div class="row">
          <button id="btnSame">Fetch & Parse</button>
          <span class="muted small">Works only if target is the same origin as this page.</span>
        </div>
      </section>

      <!-- Lane B: Paste HTML / Upload file -->
      <section>
        <div class="label">B) Paste HTML or upload an .html file</div>
        <textarea id="htmlInput" rows="6" placeholder="Paste full HTML here..."></textarea>
        <div class="row">
          <input id="fileInput" type="file" accept=".html,text/html" />
          <button id="btnParseHtml">Parse Pasted/Uploaded</button>
          <span class="muted small">Zero network calls; no CORS headaches.</span>
        </div>
      </section>
    </div>

    <hr style="margin:1.25rem 0; border:none; border-top:1px solid #eee;">

    <!-- Lane C: Third-party metadata API -->
    <section>
      <div class="label">C) Metadata API (optional)</div>
      <input id="apiUrl" type="url" placeholder="https://example-api/inspect?url={URL}" />
      <div class="muted small">Tip: use <code>{URL}</code> placeholder. We’ll substitute the target URL.</div>
      <div class="row" style="margin-top:.5rem;">
        <input id="targetForApi" type="url" placeholder="https://example.com" />
        <button id="btnApi">Ask API</button>
      </div>
    </section>

    <div id="out" class="result"></div>
  </div>

  <script>
    function extractMeta(html, baseHref) {
      // Parse HTML into a DOM without executing scripts
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Try OG -> twitter -> <title>
      const pick = (sel, attr) => {
        const el = doc.querySelector(sel);
        return el ? (attr ? el.getAttribute(attr) : el.textContent).trim() : null;
      };

      const ogTitle = pick('meta[property="og:title"]', 'content');
      const twTitle = pick('meta[name="twitter:title"]', 'content');
      const title = ogTitle || twTitle || pick('title');

      const ogDesc = pick('meta[property="og:description"]', 'content');
      const desc = ogDesc || pick('meta[name="description"]', 'content');

      const lang = (doc.documentElement.getAttribute('lang') || '').trim() || null;

      // Try favicon
      let iconHref =
        pick('link[rel="icon"]', 'href') ||
        pick('link[rel="shortcut icon"]', 'href') ||
        '/favicon.ico';

      try { if (baseHref) iconHref = new URL(iconHref, baseHref).toString(); } catch {}

      // Canonical
      let canonical = pick('link[rel="canonical"]', 'href');
      try { if (canonical && baseHref) canonical = new URL(canonical, baseHref).toString(); } catch {}

      return { title: title || null, description: desc || null, lang, favicon: iconHref || null, canonical: canonical || null };
    }

    function show(data, targetUrl, mode) {
      const out = document.getElementById('out');
      const safe = (s) => s == null ? '' : String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      out.innerHTML = `
        <div class="kv">
          <div><strong>Mode:</strong> ${safe(mode)}</div>
          ${targetUrl ? `<div><strong>URL:</strong> <a href="${safe(targetUrl)}" target="_blank" rel="noopener noreferrer">${safe(targetUrl)}</a></div>` : ''}
          <div><strong>Title:</strong> ${safe(data.title) || '<span class="muted">(none)</span>'}</div>
          <div><strong>Description:</strong> ${safe(data.description) || '<span class="muted">(none)</span>'}</div>
          <div><strong>Language:</strong> ${safe(data.lang) || '<span class="muted">(unknown)</span>'}</div>
          <div><strong>Canonical:</strong> ${data.canonical ? `<a href="${safe(data.canonical)}" target="_blank" rel="noopener noreferrer">${safe(data.canonical)}</a>` : '<span class="muted">(none)</span>'}</div>
          <div><strong>Favicon:</strong> ${data.favicon ? `<img src="${safe(data.favicon)}" alt="favicon" style="width:16px;height:16px;vertical-align:middle;margin-right:.4rem;"> ${safe(data.favicon)}` : '<span class="muted">(none)</span>'}</div>
        </div>
      `;
    }

    function error(msg) {
      const out = document.getElementById('out');
      out.innerHTML = `<div class="err">${msg}</div>`;
    }

    // Lane A: Same-origin fetch
    document.getElementById('btnSame').addEventListener('click', async () => {
      const url = document.getElementById('sameUrl').value.trim();
      if (!url) return error('Give me a URL, boss.');
      try {
        // Enforce same-origin by comparing origins
        const u = new URL(url, location.href);
        if (u.origin !== location.origin) {
          return error('Same-origin only. Host it on the same domain or use the other lanes.');
        }
        const resp = await fetch(u.toString(), { credentials: 'same-origin' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const ct = resp.headers.get('content-type') || '';
        if (!ct.includes('text/html')) throw new Error('Not HTML');
        const html = await resp.text();
        const meta = extractMeta(html, u.toString());
        show(meta, u.toString(), 'Same-origin fetch');
      } catch (e) {
        error(e.message || 'Fetch failed');
      }
    });

    // Lane B: Paste/Upload
    document.getElementById('btnParseHtml').addEventListener('click', async () => {
      let html = document.getElementById('htmlInput').value;
      const file = document.getElementById('fileInput').files[0];
      try {
        if (!html && file) html = await file.text();
        if (!html) return error('Paste HTML or select a file first.');
        const meta = extractMeta(html, null);
        show(meta, null, 'Local HTML (paste/upload)');
      } catch (e) {
        error(e.message || 'Parsing failed');
      }
    });

    // Lane C: Metadata API
    document.getElementById('btnApi').addEventListener('click', async () => {
      const tmpl = document.getElementById('apiUrl').value.trim();
      const target = document.getElementById('targetForApi').value.trim();
      if (!tmpl || !target) return error('Provide both API template and target URL.');
      try {
        const endpoint = tmpl.replace('{URL}', encodeURIComponent(target));
        const resp = await fetch(endpoint);
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
        // Try to normalize common field names
        const meta = {
          title: data.title || data.result?.title || data.data?.title || null,
          description: data.description || data.result?.description || data.data?.description || null,
          lang: data.lang || null,
          favicon: data.favicon || data.icon || null,
          canonical: data.canonical || null
        };
        show(meta, target, 'Third-party API');
      } catch (e) {
        error(e.message || 'API failed');
      }
    });
  </script>
</body>
</html>
